name: Self-Heal (rule-based)

on:
  workflow_run:
    workflows: ["Deploy to Vercel (auto + manual)"]
    types: [completed]

permissions:
  contents: write   # nodig om te kunnen committen

jobs:
  heal:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fix common Next.js issues automatically
        shell: bash
        run: |
          set -e
          FILE="ai_shop_vercel_ready/next.config.js"

          # Reset next.config.js naar veilige template
          if [ -f "$FILE" ]; then
            cat > "$FILE" <<'JS'
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  images: { remotePatterns: [{ protocol: "https", hostname: "picsum.photos" }] },
};
module.exports = nextConfig;
JS
            echo "next.config.js reset to safe template."
          fi

          # next.config.ts uitschakelen (indien aanwezig)
          if [ -f "ai_shop_vercel_ready/next.config.ts" ]; then
            mv ai_shop_vercel_ready/next.config.ts ai_shop_vercel_ready/next.config.ts.bak || true
            echo "Renamed next.config.ts to .bak to avoid TS config issue."
          fi

      - name: Commit fixes
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore(self-heal): reset next.config.js (auto-fix)"
          add: |
            ai_shop_vercel_ready/next.config.js
            ai_shop_vercel_ready/next.config.ts.bak
